<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#630d16">
    <title>DEMO ADMIN - Fashion Empire</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { --imperial: #630d16; --oro: #d4af37; --fondo: #0a0a0a; --tarjeta: #1a1a1a; --texto: #f4f4f4; --verde: #2ecc71; --rojo: #e74c3c; --plata: #c0c0c0; --alerta: #f39c12; }
        
        body { 
            font-family: 'Montserrat', sans-serif; 
            background: var(--fondo); 
            color: var(--texto); 
            margin: 0; 
            padding: 15px;
            opacity: 1; /* Visible inmediatamente */
        }

        h2 { font-family: 'Playfair Display', serif; color: var(--oro); text-align: center; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px;}
        .alert-console { background: rgba(243, 156, 18, 0.1); border: 1px solid var(--alerta); border-radius: 8px; padding: 10px; margin-bottom: 15px; display: none; }
        .alert-item { color: var(--alerta); font-size: 0.85rem; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .card { background: var(--tarjeta); padding: 20px; border-radius: 12px; border-top: 4px solid var(--imperial); margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        label { color: var(--oro); font-size: 0.75rem; font-weight: bold; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .val { font-size: 1.2rem; font-weight: bold; display: block; }
        input, select { width: 100%; padding: 12px; margin-bottom: 15px; background: #222; border: 1px solid #444; color: white; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; text-transform: uppercase; font-size: 0.8rem; transition: 0.3s; margin-bottom: 8px; }
        .btn-save { background: var(--imperial); color: white; box-shadow: 0 4px 10px rgba(128,0,32,0.3); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #111; border-radius: 8px; overflow: hidden; }
        th { text-align: left; color: var(--oro); border-bottom: 2px solid var(--imperial); padding: 12px 10px; font-size: 0.75rem; }
        td { padding: 10px; border-bottom: 1px solid #222; font-size: 0.8rem; }
        .main-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 850px) { .main-layout { grid-template-columns: 1fr; } }
        
        /* En la demo, todo lo admin se ve siempre */
        .admin-only { display: block !important; }
        .demo-badge { background: var(--oro); color: black; padding: 4px 10px; border-radius: 20px; font-weight: bold; font-size: 10px; }
    </style>
</head>
<body>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <span class="demo-badge">MODO DEMO INTERACTIVO</span>
        <span id="roleBadge" style="color: var(--oro); font-size: 0.7rem; font-weight: bold; border: 1px solid var(--oro); padding: 5px 10px; border-radius: 12px;">ROL: DUE√ëO</span>
    </div>

    <header style="text-align: center; margin-bottom: 15px;">
        <h2 style="margin-top: 10px;">The Fashion Empire</h2>
        <p style="color: var(--plata); font-style: italic; margin: 0; font-size: 0.8rem;">Panel de Control Administrativo</p>
    </header>

    <div id="alertConsole" class="alert-console">
        <label style="color: var(--alerta); margin-bottom: 10px; display: block;">‚ö†Ô∏è Alertas de Stock Bajo</label>
        <div id="alertList"></div>
    </div>

    <div class="grid-stats">
        <div class="card" id="cardCapital" style="border-top-color: var(--oro)">
            <label>Capital Invertido</label>
            <span id="capInvertido" class="val">$0</span>
        </div>
        <div class="card" style="border-top-color: var(--verde)">
            <label>Ventas Hoy</label>
            <span id="ventasDia" class="val" style="color: var(--verde)">$0</span>
        </div>
        <div class="card" style="border-top-color: var(--plata)">
            <label>Items Totales</label>
            <span id="contadorItems" class="val">0</span>
        </div>
    </div>

    <div class="main-layout">
        <div>
            <div class="card">
                <label>üëë Agregar Nueva Prenda</label>
                <input type="text" id="nom" placeholder="Nombre de la Prenda">
                <div class="grid-inputs">
                    <div><label>Talle</label><input type="text" id="talle" placeholder="Talle"></div>
                    <div><label>Color</label><input type="text" id="color" placeholder="Color"></div>
                </div>
                <div class="grid-inputs">
                    <div><label>Costo ($)</label><input type="number" id="cos" placeholder="0"></div>
                    <div><label>Venta ($)</label><input type="number" id="pre" placeholder="0"></div>
                </div>
                <div class="grid-inputs">
                    <div><label>Stock</label><input type="number" id="sto" placeholder="Cant."></div>
                    <div><label>C√≥digo</label><input type="text" id="cod" placeholder="C√≥digo"></div>
                </div>
                <button class="btn btn-save" onclick="guardarPrenda()">üíæ REGISTRAR EN DB</button>
            </div>

            <div class="card">
                <label>üìà Rendimiento de Ventas</label>
                <canvas id="graficoVentas" height="150"></canvas>
            </div>
        </div>

        <div>
            <div class="card" style="border-top-color: var(--verde)">
                <label>üõçÔ∏è √öltimos Movimientos</label>
                <div style="max-height: 380px; overflow-y: auto;">
                    <table>
                        <thead><tr><th>HORA</th><th>DETALLE</th><th>TOTAL</th></tr></thead>
                        <tbody id="cuerpoVentas"></tbody>
                    </table>
                </div>
            </div>

            <div class="card" style="border-top-color: var(--plata)">
                <label>üì¶ Inventario en Tiempo Real</label>
                <div style="max-height: 500px; overflow-y: auto;">
                    <table id="tablaInv">
                        <thead><tr><th>DETALLE</th><th style="text-align: center;">STOCK</th><th style="text-align: right;">PRECIO</th></tr></thead>
                        <tbody id="cuerpoTabla"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
    const SB_URL = "https://svpurpvbiujhcbiugrkh.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2cHVycHZiaXVqaGNiaXVncmtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NDgzMTUsImV4cCI6MjA4MzMyNDMxNX0.AivKJ0_N0z_4T4vLNfUcE2hepJ1XXOO8-4fSA3PJXdc";
    const _supabase = supabase.createClient(SB_URL, SB_KEY);
    
    let todosLosProductos = [];
    let graficoInstance = null;

    // CARGA DIRECTA PARA LA DEMO
    window.onload = () => {
        cargarTodo();
    };

    async function cargarTodo() {
        const { data: productos } = await _supabase.from('productos_boutique').select('*').order('created_at', { ascending: false });
        todosLosProductos = productos || [];
        renderizarTabla(todosLosProductos);
        actualizarAlertas(todosLosProductos);
        cargarVentasYGrafico();
    }

    function renderizarTabla(lista) {
        const tbody = document.getElementById('cuerpoTabla');
        tbody.innerHTML = "";
        document.getElementById('contadorItems').innerText = lista.length;
        lista.forEach(item => {
            const stockBajo = item.stock <= 2;
            tbody.innerHTML += `
                <tr>
                    <td><strong>${item.nombre}</strong><br><small style="color:var(--plata)">${item.talle} | ${item.color}</small></td>
                    <td style="text-align: center;">
                        <span style="color: ${stockBajo ? 'var(--rojo)' : 'var(--verde)'}; font-weight: bold;">${item.stock}</span>
                    </td>
                    <td style="text-align: right; font-weight: bold; color: var(--oro);">$${item.precio_venta.toLocaleString()}</td>
                </tr>`;
        });
        actualizarMetricas(lista);
    }

    async function cargarVentasYGrafico() {
        const { data: ventas } = await _supabase.from('ventas_boutique').select('*').order('created_at', { ascending: false });
        procesarVentas(ventas || []);
        cargarGrafico(ventas || []);
    }

    function procesarVentas(ventas) {
        const hoy = new Date().toISOString().split('T')[0];
        const tbody = document.getElementById('cuerpoVentas');
        let sumaHoy = 0;
        tbody.innerHTML = "";
        
        ventas.slice(0, 10).forEach(v => { // Solo las √∫ltimas 10 para la demo
            if (v.created_at.startsWith(hoy)) sumaHoy += v.total;
            const hora = new Date(v.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            tbody.innerHTML += `<tr>
                <td><small>${hora}</small></td>
                <td><small>${v.detalles}</small></td>
                <td style="font-weight:bold; color:var(--verde)">$${v.total.toLocaleString()}</td>
            </tr>`;
        });
        document.getElementById('ventasDia').innerText = `$${sumaHoy.toLocaleString()}`;
    }

    function actualizarMetricas(data) {
        let cap = 0; 
        data.forEach(p => cap += (p.precio_costo * p.stock));
        document.getElementById('capInvertido').innerText = `$${cap.toLocaleString()}`;
    }

    async function cargarGrafico(ventas) {
        const montos = [0,0,0,0,0,0,0];
        ventas.forEach(v => { montos[new Date(v.created_at).getDay()] += v.total; });
        const ctx = document.getElementById('graficoVentas').getContext('2d');
        if (graficoInstance) graficoInstance.destroy();
        graficoInstance = new Chart(ctx, {
            type: 'bar',
            data: { 
                labels: ['D','L','M','X','J','V','S'], 
                datasets: [{ data: montos, backgroundColor: '#d4af37', borderRadius: 5 }] 
            },
            options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#333' } } } }
        });
    }

    async function guardarPrenda() {
        const datos = {
            codigo_barras: document.getElementById('cod').value || "DEMO-" + Date.now(),
            nombre: document.getElementById('nom').value,
            talle: document.getElementById('talle').value,
            color: document.getElementById('color').value,
            categoria: document.getElementById('cat').value,
            precio_costo: parseFloat(document.getElementById('cos').value) || 0,
            precio_venta: parseFloat(document.getElementById('pre').value) || 0,
            stock: parseInt(document.getElementById('sto').value) || 0
        };
        await _supabase.from('productos_boutique').upsert(datos);
        Swal.fire({ title: '¬°Guardado!', text: 'Producto actualizado en la base de datos real.', icon: 'success', background: '#1a1a1a', color: '#fff' });
        cargarTodo();
    }

    function actualizarAlertas(productos) {
        const alertList = document.getElementById('alertList');
        const criticos = productos.filter(p => p.stock <= 2);
        document.getElementById('alertConsole').style.display = criticos.length ? 'block' : 'none';
        alertList.innerHTML = criticos.map(p => `<div class="alert-item"><span>‚ö†Ô∏è</span> <strong>${p.nombre}</strong> - Quedan ${p.stock}</div>`).join('');
    }
</script>
</body>
</html>